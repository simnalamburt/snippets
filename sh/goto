#!/bin/bash

# fzfë¡œ ì›í•˜ëŠ” íŒŒì¼ ë‚´ìš©ì„ ê²€ìƒ‰í•œ ë’¤, vimìœ¼ë¡œ ì—´ì–´ì£¼ëŠ” í”„ë¡œê·¸ë¨.
# ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ì™€ ë‹¤ì¤‘ì„ íƒë„ ì§€ì›í•œë‹¤.
#
# Requirements:
#   rg
#   fzf
#   bat (optional)
#
# Special thanks to @xnuk https://github.com/xnuk/

set -euo pipefail; IFS=$'\n\t'

PREVIEW='
  LINE={2}
  LINE=${LINE%?}
  BEGIN=$((LINE > FZF_PREVIEW_LINES/2 ? LINE - FZF_PREVIEW_LINES/2 + 1 : 1))
  END=$((BEGIN + FZF_PREVIEW_LINES - 1))
'

# batì´ ì—†ì„ê²½ìš° sedë¥¼ bat ëŒ€ì‹  ì‚¬ìš©í•œë‹¤.
if [ -x "$(command -v bat)" ]; then
  PREVIEW=$PREVIEW'; bat -ppH$LINE --color=always -r$BEGIN:$END {1}'
else
  PREVIEW=$PREVIEW'; sed -n "${BEGIN},${END}p" {1}'
fi

ARGS=$(
  rg --no-config -nH0 --color=always '\A' -r'ğŸŒğŸ”¥ğŸ¸ğŸ¹ğŸ˜‚ğŸ˜ğŸ˜˜' |
  fzf -m -d'\0|ğŸŒğŸ”¥ğŸ¸ğŸ¹ğŸ˜‚ğŸ˜ğŸ˜˜' -n'2..' --with-nth='1,3..' \
    --ansi --color=border:0 --layout=reverse --preview="${PREVIEW}" |
  rg --no-config -a '\A(.*)\x00(.*):ğŸŒğŸ”¥ğŸ¸ğŸ¹ğŸ˜‚ğŸ˜ğŸ˜˜(.*)$' -r'+"tabnew +$2 $1"'
)

eval exec vim ${ARGS} +1tabclose
